# .github/workflows/main_taskusbr.yml

name: Deploy Full-Stack App to Azure App Service

on:
  push:
    branches:
      - main # Altere para o seu branch principal, se for diferente

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev # Opcional: use o nome do seu ambiente no GitHub

    steps:
    # 1. Checkout do Código
    - uses: actions/checkout@v4

    # 2. Configuração do Node.js (para o Frontend)
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' # Use a versão do Node.js que você usa para o Vite/React

    # 3. Build do Frontend (webapp)
    - name: Install and Build Frontend
      run: |
        cd webapp
        npm install # Instala as dependências do Node.js
        npm run build # Executa o script de build (que deve usar o vite.config.js modificado)
      # O resultado da build deve estar em 'serverapp/static' conforme a Fase 3

    # 4. Configuração do Python (para o Backend)
    - name: Set up Python version
      uses: actions/setup-python@v5
      with:
        python-version: '3.12' # Versão do Python do seu App Service

    # 5. Instalação das Dependências do Backend
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      # Nota: O Azure App Service fará isso na implantação, mas é bom para testes de CI

    # 6. Implantação no Azure App Service
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'taskusbr' # **MUDAR** para o nome exato do seu App Service
        slot-name: 'production' # Mantenha 'production' ou use um slot de staging
        package: . # Implanta todo o conteúdo do repositório (incluindo a build do frontend)
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_TASKUSBR }}
        # O nome do segredo (secrets.AZUREAPPSERVICE_PUBLISHPROFILE_...) é gerado pelo Azure.
        # Verifique o nome exato no seu repositório GitHub em Settings -> Secrets -> Actions.
